<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #f1c40f;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .dashboard-header {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 10px;
      justify-content: space-between; /* Distribute cards evenly */
    }

    .card {
      background-color: #1e1e1e;
      padding: 10px;
      border-radius: 2px;
      box-shadow: 0 0 2px rgba(241, 196, 15, 0.5);
      flex: 1 1 calc(20% - 20px); /* Each card will take 25% of the width minus the gap */
      min-width: 100px; /* Ensure the card isn't too small on smaller screens */
      text-align: center;
      position: relative;
    }

    .card h2 {
      margin: 10px 0;
      font-size: 18px;
      color: #f39c12;
    }

    .card p {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }

    .dates {
      font-size: 12px !important;
      font-weight: bold;
      margin: 0;
    }

    .edit-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 18px;
      color: #f1c40f;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
      border-radius: 2px;
      box-shadow: 0 0 2px rgba(241, 196, 15, 0.5);
      overflow: hidden;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    th {
      background-color: #2c2c2c;
      color: #f1c40f;
      font-size: 16px;
    }

    tr:hover {
      background-color: #2a2a2a;
    }

    td {
      color: #f9f871;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal {
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 10px #f1c40f88;
    }

    .modal input[type="datetime-local"] {
      background-color: #222;
      color: #f1c40f;
      border: 1px solid #f1c40f;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 20px;
      width: 100%;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-around;
    }

    .modal-buttons button {
      background: #f1c40f;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      color: #121212;
    }
    .divider {
      border: none;
      border-top: 1px solid #f1c40f; /* Yellow color for the divider */
      margin: 20px 0;  /* Space around the divider */
      width: 100%;
    }

  </style>
</head>
<body>

  <h1>Admin Dashboard</h1>
  <hr class="divider">

  <div class="dashboard-header">
    <div class="card">
      <h2>Markup Value</h2>
      <p id="amount">$--,--</p>
    </div>
    <div class="card">
      <h2>Transactions Count</h2>
      <p id="trans">---</p>
    </div>
    <div class="card">
      <h2>Date From
        <span class="edit-icon" onclick="openModal('dateFromDisplay')">✏️</span>
      </h2>
      <p class="dates" id="dateFromDisplay">2025-01-01 00:00</p>
    </div>
    <div class="card">
      <h2>Date To
        <span class="edit-icon" onclick="openModal('dateToDisplay')">✏️</span>
      </h2>
      <p class="dates" id="dateToDisplay">2025-12-31 00:00</p>
    </div>
  </div>


  <div style="margin-bottom: 10px;">
    <canvas id="myChart" height="60"></canvas>
  </div>


  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>App ID</th>
        <th>Markup</th>
        <th>Currency</th>
      </tr>
    </thead>
    <tbody>
      
  </table>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3>Select Date & Time</h3>
      <input type="datetime-local" id="modalDatetimeInput">
      <div class="modal-buttons">
        <button onclick="confirmDate()">OK</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="loginOverlay" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #121212;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    color: #f1c40f;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  ">
    <h2 style="margin-bottom: 20px;">Login</h2>
    <input type="password" id="passwordInput" placeholder="Enter password" style="
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #f1c40f;
      border-radius: 8px;
      background: #1e1e1e;
      color: #f1c40f;
      width: 250px;
      text-align: center;
    ">
    <button onclick="checkPassword()" style="
      padding: 10px 20px;
      background: #f1c40f;
      color: #121212;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    ">Login</button>
  </div>


  <script>
    let selectedDateElement = ''; // Track which date is being edited

    function openModal(displayId) {
      selectedDateElement = displayId; // Store the element to be updated
      const modal = document.getElementById('modalOverlay');
      const currentText = document.getElementById(displayId).innerText;
      const [datePart, timePart] = currentText.split(' ');
      const isoString = datePart + 'T' + timePart;
      document.getElementById('modalDatetimeInput').value = isoString;
      
      modal.style.display = 'flex';
    }

    function closeModal() {
      const modal = document.getElementById('modalOverlay');
      modal.style.display = 'none';
    }

    function confirmDate() {
      const input = document.getElementById('modalDatetimeInput');
      const selected = new Date(input.value);
      
      if (!isNaN(selected)) {
        const formatted = selected.getFullYear() + '-' +
          String(selected.getMonth() + 1).padStart(2, '0') + '-' +
          String(selected.getDate()).padStart(2, '0') + ' ' +
          String(selected.getHours()).padStart(2, '0') + ':' +
          String(selected.getMinutes()).padStart(2, '0');

        document.getElementById(selectedDateElement).innerText = formatted;

        // Show a dialog with the new date
        getConnection();
      }
      closeModal();
    }

    var APP_ID = 72081;
    const token = '8WtdpYtwJ1pYoOq';
    
    function getConnection() {
        let dateFromDisplay = document.getElementById('dateFromDisplay').innerText + ':00';
        let dateToDisplay = document.getElementById('dateToDisplay').innerText  + ':00';
        let ws1 = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=' + APP_ID)
            
        ws1.addEventListener("open", () => {
            authorize();
        });

        ws1.addEventListener("close", (eve) => {
            //console.dir(eve);
        });

        ws1.addEventListener("error", (err) => {
            //console.dir(err);
        });

        ws1.addEventListener('message', function(data) { 
            let ms = JSON.parse(data.data);

            let req = ms.echo_req;
            var req_id = req.req_id;
            const error = ms.error;
            if (error) {
              console.log(ms)
            }
            else {
              if (req_id === 2111) {
                  console.log('authorized');
                  getMarkDetails(dateFromDisplay, dateToDisplay);
                  getMarkStatistics(dateFromDisplay, dateToDisplay);
              }
              if (req_id === 1001) {
                const tbody = document.querySelector('table tbody');
                const app_markup_details = ms.app_markup_details;
                const transactions = app_markup_details.transactions;
                let chart_data = [];
                let chart_labels = [];
                for (var i = 0; i < transactions.length; i++) {
                  const item = transactions[i]
                  // Create a new table row
                  const row = document.createElement('tr');

                  // Create table cells for each property in the item
                  const dateCell = document.createElement('td');
                  dateCell.textContent = item.transaction_time;
                  chart_labels.push(item.transaction_time.split(" ")[1])

                  const appIdCell = document.createElement('td');
                  appIdCell.textContent = item.app_id;

                  const markupCell = document.createElement('td');
                  markupCell.textContent = item.app_markup_usd;
                  chart_data.push(item.app_markup_usd);

                  const currencyCell = document.createElement('td');
                  currencyCell.textContent = item.client_currcode;

                  // Append the cells to the row
                  row.appendChild(dateCell);
                  row.appendChild(appIdCell);
                  row.appendChild(markupCell);
                  row.appendChild(currencyCell);

                  // Append the row to the tbody
                  tbody.appendChild(row);
                }

                loadChart(chart_data, chart_labels);
              }
              if (req_id === 1002) {
                const app_markup_statistics = ms.app_markup_statistics;
                const total_app_markup_usd = app_markup_statistics.total_app_markup_usd;
                const total_transactions_count = app_markup_statistics.total_transactions_count;
                document.getElementById('amount').innerText = total_app_markup_usd.toFixed(2) + ' USD';
                document.getElementById('trans').innerText = total_transactions_count;
              }
            }
        });

        function authorize() {
            const msg = JSON.stringify({
                authorize: token,
                req_id: 2111
            });
            if (ws1.readyState !== WebSocket.CLOSED) {
                ws1.send(msg);
            }
        }

        function getMarkDetails(dateFromDisplay, dateToDisplay) {
              const msg = JSON.stringify({
                  "app_markup_details": 1,
                  "description": 1,
                  "date_from": dateFromDisplay,
                  "date_to": dateToDisplay,
                  "limit": 100,
                  "offset": 0,
                  "sort": "ASC",
                  "req_id": 1001
              });
              if (ws1.readyState !== WebSocket.CLOSED) {
                  ws1.send(msg);
              }
        }

        function getMarkStatistics(dateFromDisplay, dateToDisplay) {
              const msg = JSON.stringify({
                  "app_markup_statistics": 1,
                  "date_from": dateFromDisplay,
                  "date_to": dateToDisplay,
                  "req_id": 1002
              });
              if (ws1.readyState !== WebSocket.CLOSED) {
                  ws1.send(msg);
              }
        }
    }
    getConnection();

    function loadChart(chart_data, chart_labels) {
      const chartLabels = chart_labels;
      const chartData = chart_data;

      const ctx = document.getElementById('myChart').getContext('2d');

      const myChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: chartLabels,
              datasets: [{
                  label: 'Markup',
                  data: chartData,
                  fill: true,
                  backgroundColor: 'rgba(241, 196, 15, 0.2)', // light yellow area
                  borderColor: '#f1c40f', // yellow line
                  tension: 0.4,
                  pointRadius: 0,
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  legend: {
                      labels: {
                          color: '#f1c40f', // legend text color
                      }
                  }
              },
              scales: {
                  x: {
                      ticks: {
                          color: '#f1c40f', // x-axis labels color
                          font: {
                              size: 8 // 👈 reduce the text size (change the number as needed)
                          }
                      },
                      grid: {
                          display: false,
                          color: '#333' // x-axis grid color
                      }
                  },
                  y: {
                      ticks: {
                          color: '#f1c40f', // y-axis labels color
                          font: {
                              size: 12 // 👈 reduce the text size (change the number as needed)
                          }
                      },
                      grid: {
                          display: false,
                          color: '#333' // y-axis grid color
                      },
                      font: {
                          size: 5 // 👈 reduce the text size (change the number as needed)
                      }
                  }
              }
          }
      });

    }

    function checkPassword() {
      const input = document.getElementById('passwordInput').value;
      if (input === '1234') {
        document.getElementById('loginOverlay').style.display = 'none';
      } else {
        alert('Incorrect password!');
      }
    }

  </script>

</body>
</html>
